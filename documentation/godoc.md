<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# code

```go
import "github.com/ghowland/sireus/code"
```

## Index



# app

```go
import "github.com/ghowland/sireus/code/app"
```

## Index

- [func AreAllActionStatesActive(action data.Action, bot data.Bot) bool](<#func-areallactionstatesactive>)
- [func AverageAndFixup(runningScore float64, considerCount int) (float64, []string)](<#func-averageandfixup>)
- [func CalculateScore(action data.Action, actionData data.BotActionData) (float64, []string)](<#func-calculatescore>)
- [func FormatBotVariable(format data.BotVariableFormat, value float64) string](<#func-formatbotvariable>)
- [func GetAPIPlotData(appConfig data.AppConfig, c *fiber.Ctx) string](<#func-getapiplotdata>)
- [func GetAction(botGroup data.BotGroup, actionName string) (data.Action, error)](<#func-getaction>)
- [func GetActionConsideration(action data.Action, considerName string) (data.ActionConsideration, error)](<#func-getactionconsideration>)
- [func GetBot(botGroup data.BotGroup, botName string) (data.Bot, error)](<#func-getbot>)
- [func GetBotGroup(interactiveControl data.InteractiveControl, site *data.Site, botGroupName string) (data.BotGroup, error)](<#func-getbotgroup>)
- [func GetCurveDataX(curveData CurveData) []float64](<#func-getcurvedatax>)
- [func GetCurveValue(curveData CurveData, x float64) float64](<#func-getcurvevalue>)
- [func GetInteractiveSession(interactiveControl data.InteractiveControl, site *data.Site) data.InteractiveSession](<#func-getinteractivesession>)
- [func GetProductionInteractiveControl() data.InteractiveControl](<#func-getproductioninteractivecontrol>)
- [func GetQuery(botGroup data.BotGroup, queryName string) (data.BotQuery, error)](<#func-getquery>)
- [func GetQueryServer(site data.Site, name string) (data.QueryServer, error)](<#func-getqueryserver>)
- [func GetVariable(botGroup data.BotGroup, varName string) (data.BotVariable, error)](<#func-getvariable>)
- [func LoadBotGroupConfig(path string) data.BotGroup](<#func-loadbotgroupconfig>)
- [func LoadConfig(path string) data.AppConfig](<#func-loadconfig>)
- [func LoadSiteConfig(appConfig data.AppConfig) data.Site](<#func-loadsiteconfig>)
- [func SortMapStringActionDataByFinalScore(input map[string]data.BotActionData, sortForward bool) data.PairBotActionDataList](<#func-sortmapstringactiondatabyfinalscore>)
- [type CurveData](<#type-curvedata>)
  - [func LoadCurveData(appConfig data.AppConfig, name string) CurveData](<#func-loadcurvedata>)


## func [AreAllActionStatesActive](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L138>)

```go
func AreAllActionStatesActive(action data.Action, bot data.Bot) bool
```

For a given Action, does this Bot have all the RequiredStates active?

## func [AverageAndFixup](<https://github.com/ghowland/sireus/blob/main/code/app/score.go#L61>)

```go
func AverageAndFixup(runningScore float64, considerCount int) (float64, []string)
```

This is the heuristic we use to get a good "modified average" of the Considerations to a Consideration Final Score This works well when all the ActionConsideration.Weight values are \~1.0, so that they have relative importance to each other.  Try to keep ActionConsideration.Weight values between 0.1 and 10.0 for a good result.

## func [CalculateScore](<https://github.com/ghowland/sireus/blob/main/code/app/score.go#L10>)

```go
func CalculateScore(action data.Action, actionData data.BotActionData) (float64, []string)
```

Calculate the Utility Score for a given Action using a Bot's BotActionData

## func [FormatBotVariable](<https://github.com/ghowland/sireus/blob/main/code/app/format_human.go#L12>)

```go
func FormatBotVariable(format data.BotVariableFormat, value float64) string
```

Bot.VariableValues are all floats, but we want them to have human readable strings

## func [GetAPIPlotData](<https://github.com/ghowland/sireus/blob/main/code/app/plot.go#L12>)

```go
func GetAPIPlotData(appConfig data.AppConfig, c *fiber.Ctx) string
```

Returns JSON data needed to create a Plotly graph for our Curves

## func [GetAction](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L108>)

```go
func GetAction(botGroup data.BotGroup, actionName string) (data.Action, error)
```

Get an Action from a BotGroup, by name

## func [GetActionConsideration](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L128>)

```go
func GetActionConsideration(action data.Action, considerName string) (data.ActionConsideration, error)
```

Get an ActionConsideration from an Action, by name

## func [GetBot](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L149>)

```go
func GetBot(botGroup data.BotGroup, botName string) (data.Bot, error)
```

Get a Bot from the BotGroup

## func [GetBotGroup](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L159>)

```go
func GetBotGroup(interactiveControl data.InteractiveControl, site *data.Site, botGroupName string) (data.BotGroup, error)
```

Gets a BotGroup from the Site, using the InteractiveControl

## func [GetCurveDataX](<https://github.com/ghowland/sireus/blob/main/code/app/curves.go#L36>)

```go
func GetCurveDataX(curveData CurveData) []float64
```

Get all X axis values, which is just the step from 0\-1 at 0.1 intervals

## func [GetCurveValue](<https://github.com/ghowland/sireus/blob/main/code/app/curves.go#L47>)

```go
func GetCurveValue(curveData CurveData, x float64) float64
```

Get the Y value, at an X position, in the curve

## func [GetInteractiveSession](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L51>)

```go
func GetInteractiveSession(interactiveControl data.InteractiveControl, site *data.Site) data.InteractiveSession
```

## func [GetProductionInteractiveControl](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L73>)

```go
func GetProductionInteractiveControl() data.InteractiveControl
```

GetProductionInteractiveControl returns a SessionUUID==0 data set for production data. TODO\(ghowland\): These should be altered by AppConfig

## func [GetQuery](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L98>)

```go
func GetQuery(botGroup data.BotGroup, queryName string) (data.BotQuery, error)
```

Gets a query, scope per BotGroup

## func [GetQueryServer](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L87>)

```go
func GetQueryServer(site data.Site, name string) (data.QueryServer, error)
```

Returns a QueryServer, scope is per Site

## func [GetVariable](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L118>)

```go
func GetVariable(botGroup data.BotGroup, varName string) (data.BotVariable, error)
```

Get a Variable defintion from BotGroup, by name.  Not the Variable Value, which is stored in Bot.

## func [LoadBotGroupConfig](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L14>)

```go
func LoadBotGroupConfig(path string) data.BotGroup
```

Load the BotGroup config from a path

## func [LoadConfig](<https://github.com/ghowland/sireus/blob/main/code/app/config.go#L11>)

```go
func LoadConfig(path string) data.AppConfig
```

Load the Server config

## func [LoadSiteConfig](<https://github.com/ghowland/sireus/blob/main/code/app/bot_group.go#L26>)

```go
func LoadSiteConfig(appConfig data.AppConfig) data.Site
```

Load our Site config for a path

## func [SortMapStringActionDataByFinalScore](<https://github.com/ghowland/sireus/blob/main/code/app/fix_go_sort.go#L9>)

```go
func SortMapStringActionDataByFinalScore(input map[string]data.BotActionData, sortForward bool) data.PairBotActionDataList
```

Go doesnt handle map sorting easily, so this is the fix\-up

## type [CurveData](<https://github.com/ghowland/sireus/blob/main/code/app/curves.go#L13-L16>)

Points to create a curve.  Standard is 0\-1 at 0.1 steps, so 1000 points

```go
type CurveData struct {
    Name   string    `json:"name"`
    Values []float64 `json:"values"`
}
```

### func [LoadCurveData](<https://github.com/ghowland/sireus/blob/main/code/app/curves.go#L20>)

```go
func LoadCurveData(appConfig data.AppConfig, name string) CurveData
```

Load the Curve data off the disk

# data

```go
import "github.com/ghowland/sireus/code/data"
```

## Index

- [Variables](<#variables>)
- [type Action](<#type-action>)
- [type ActionCommand](<#type-actioncommand>)
- [type ActionCommandResult](<#type-actioncommandresult>)
- [type ActionCommandType](<#type-actioncommandtype>)
  - [func (act ActionCommandType) String() string](<#func-actioncommandtype-string>)
- [type ActionConsideration](<#type-actionconsideration>)
- [type AppConfig](<#type-appconfig>)
- [type Bot](<#type-bot>)
- [type BotActionData](<#type-botactiondata>)
- [type BotExtractorQueryKey](<#type-botextractorquerykey>)
- [type BotForwardSequenceState](<#type-botforwardsequencestate>)
- [type BotGroup](<#type-botgroup>)
- [type BotLockTimer](<#type-botlocktimer>)
- [type BotLockTimerType](<#type-botlocktimertype>)
  - [func (bltt BotLockTimerType) String() string](<#func-botlocktimertype-string>)
- [type BotQuery](<#type-botquery>)
- [type BotQueryType](<#type-botquerytype>)
  - [func (bqt BotQueryType) String() string](<#func-botquerytype-string>)
- [type BotVariable](<#type-botvariable>)
- [type BotVariableFormat](<#type-botvariableformat>)
- [type BotVariableType](<#type-botvariabletype>)
  - [func (bvt BotVariableType) String() string](<#func-botvariabletype-string>)
- [type Duration](<#type-duration>)
  - [func (d Duration) MarshalJSON() ([]byte, error)](<#func-duration-marshaljson>)
  - [func (d *Duration) UnmarshalJSON(b []byte) error](<#func-duration-unmarshaljson>)
- [type InteractiveControl](<#type-interactivecontrol>)
- [type InteractiveSession](<#type-interactivesession>)
- [type InteractiveSessionPool](<#type-interactivesessionpool>)
- [type Override](<#type-override>)
- [type OverrideActionConsideration](<#type-overrideactionconsideration>)
- [type OverrideBot](<#type-overridebot>)
- [type OverrideBotGroup](<#type-overridebotgroup>)
- [type PairBotActionData](<#type-pairbotactiondata>)
- [type PairBotActionDataList](<#type-pairbotactiondatalist>)
  - [func (p PairBotActionDataList) Len() int](<#func-pairbotactiondatalist-len>)
  - [func (p PairBotActionDataList) Less(i, j int) bool](<#func-pairbotactiondatalist-less>)
  - [func (p PairBotActionDataList) Swap(i, j int)](<#func-pairbotactiondatalist-swap>)
- [type PairFloat64](<#type-pairfloat64>)
- [type PairFloat64List](<#type-pairfloat64list>)
  - [func (p PairFloat64List) Len() int](<#func-pairfloat64list-len>)
  - [func (p PairFloat64List) Less(i, j int) bool](<#func-pairfloat64list-less>)
  - [func (p PairFloat64List) Swap(i, j int)](<#func-pairfloat64list-swap>)
- [type PrometheusResponse](<#type-prometheusresponse>)
- [type PrometheusResponseData](<#type-prometheusresponsedata>)
- [type PrometheusResponseDataResult](<#type-prometheusresponsedataresult>)
- [type QueryResult](<#type-queryresult>)
- [type QueryResultPool](<#type-queryresultpool>)
- [type QueryResultPoolItem](<#type-queryresultpoolitem>)
- [type QueryServer](<#type-queryserver>)
- [type QueryServerType](<#type-queryservertype>)
  - [func (qst QueryServerType) String() string](<#func-queryservertype-string>)
- [type SessionUUID](<#type-sessionuuid>)
- [type SireusServerData](<#type-sireusserverdata>)
- [type Site](<#type-site>)


## Variables

```go
var (
    // SireusData is the global data for the site, accessed by the WebApp for production and interactive ops, as well as queries
    SireusData = SireusServerData{
        IsQuitting: false,
    }
)
```

## type [Action](<https://github.com/ghowland/sireus/blob/main/code/data/action_data.go#L7-L19>)

Action is what is considered for execution.  It will receive a Final Score from it's Weight and Consideration Final Scores

```go
type Action struct {
    Name               string                `json:"name"`
    Info               string                `json:"info"`
    IsLaunched         bool                  `json:"is_launched"`      // If false, this will never execute.  Launching means it is configured and ready to run live.  When Actions are created, is_launched==false and must be changed so that the action could execute.
    IsDisabled         bool                  `json:"is_disabled"`      // When testing changes, disable with modifying config
    Weight             float64               `json:"weight"`           // This is the multiplier for the Final Score, from the Consideration Final Score
    WeightMin          float64               `json:"weight_min"`       // If Weight != 0, then this is the Floor value.  We will bump it to this value, if it is less than this value
    WeightThreshold    float64               `json:"weight_threshold"` // If non-0, this is the threshold to be Active, and potentially execute Actions.  If the Final Score is less than this Threshold, this Action can never run.  WeightMin and WeightThreshold are independent tests, and will have different results when used together, so take that into consideration.
    RequiredLockTimers []string              `json:"required_lock_timers"`
    RequiredStates     []string              `json:"required_states"`
    Considerations     []ActionConsideration `json:"considerations"`
    Command            ActionCommand         `json:"command"`
}
```

## type [ActionCommand](<https://github.com/ghowland/sireus/blob/main/code/data/action_data.go#L66-L75>)

When an Action is selected for execution by it's Final Score, the ActionCommand is executed.  A command or web request.

```go
type ActionCommand struct {
    Type              ActionCommandType `json:"type"`
    Content           string            `json:"content"`
    SuccessStatus     int               `json:"success_status"`
    SuccessContent    string            `json:"success_content"`
    LockTimerDuration Duration          `json:"lock_timer_duration"`
    HostExecKey       string            `json:"host_exec_key"`    // Sireus Client presents this key to get commands to run
    SetBotStates      []string          `json:"set_bot_states"`   // Will Advance all of these Bot States.  Advance can only go forward in the list, or start at the very beginning.  It can't go backwards, that is invalid data.  Only the State.Name and not the StateName.State is present, this will just advance to the next available state until it hits the final one and stay there.
    JournalTemplate   string            `json:"journal_template"` // Templated Text formatted with variables from the Bot.VariableValues.  This is logged in JSON log-line and can be used to create Outage Reports, etc
}
```

## type [ActionCommandResult](<https://github.com/ghowland/sireus/blob/main/code/data/action_data.go#L80-L88>)

When an Action is selected for execution by it's Final Score, the ActionCommand will execute and store this result.

```go
type ActionCommandResult struct {
    ActionName    string
    ResultStatus  string
    ResultContent string
    HostExecOn    string
    Started       time.Time
    Finished      time.Time
    Score         float64
}
```

## type [ActionCommandType](<https://github.com/ghowland/sireus/blob/main/code/data/action_data.go#L37>)

What will we do with this ActionCommand?  We will only ever do 1 thing per Action, as this is a Decision System

```go
type ActionCommandType int64
```

```go
const (
    ShellCommand    ActionCommandType = iota // Shell Command
    WebHttps                                 // HTTPS request
    WebHttpInsecure                          // HTTP request
    WebRPC                                   // RPC call
    NoOperation                              // Do nothing
)
```

### func \(ActionCommandType\) [String](<https://github.com/ghowland/sireus/blob/main/code/data/action_data.go#L48>)

```go
func (act ActionCommandType) String() string
```

## type [ActionConsideration](<https://github.com/ghowland/sireus/blob/main/code/data/action_data.go#L25-L32>)

Considerations are units for scoring an Action.  Each creates a Score, and they are combined to created the Consideration Final Score.

```go
type ActionConsideration struct {
    Name       string  `json:"name"`
    Weight     float64 `json:"weight"`
    CurveName  string  `json:"curve"`
    RangeStart float64 `json:"range_start"`
    RangeEnd   float64 `json:"range_end"`
    Evaluate   string  `json:"evaluate"`
}
```

## type [AppConfig](<https://github.com/ghowland/sireus/blob/main/code/data/config_data.go#L5-L17>)

Web App server configuration

```go
type AppConfig struct {
    WebPath                           string   `json:"web_path"`                             // Path to the Handlebars template content.  Holds *.hbs files
    SiteConfigPath                    string   `json:"site_config_path"`                     // Path to the config.yaml file that contains a Site.  For now only 1, but later will make this dynamic
    CurvePathFormat                   string   `json:"curve_path_format"`                    // String to format for each of the Curve JSON files, that contain the points we use to calculate from a curve
    ServerLoopDelay                   Duration `json:"server_loop_delay"`                    // After running the server loop, how long to delay, so we aren't in full spin lock.  This should be short like "0.8s"
    QueryLockTimeout                  Duration `json:"query_lock_timeout"`                   // We run Queries in the background, if they run longer than this, clear the lock.  This should be a longer time, like "60s".  TODO(ghowland): Pass in custom contexts and cancel them?  Better to really control it.
    QueryFastInternal                 Duration `json:"query_fast_interval"`                  // BotQuery.Interval is overridden when users interact with the app, so they get fast interactive responses
    QueryFastDuration                 Duration `json:"query_fast_duration"`                  // Duration QueryFastInterval is maintained after the last user interaction
    InteractiveSessionTimeout         Duration `json:"interactive_session_timeout"`          // Duration an InteractiveSession is kept until it is assumed finished, and can be purged
    InteractiveDurationMinutesDefault int      `json:"interactive_duration_minutes_default"` // How many minutes we default to starting the interactive query to.  15 minutes is reasonable
    ReloadTemplatesAlways             bool     `json:"reload_templates_always"`              // For development, if true this will always reload Handlebars files.  Only need to reestart the server to rebuild code.
    LogTemplateParsing                bool     `json:"log_template_parsing"`                 // For web development debugging, if true this will print out all the templates that are parsed.  It's not generally useful, but if you are having a problem with Handlebars template imports or related it can help
}
```

## type [Bot](<https://github.com/ghowland/sireus/blob/main/code/data/bot_data.go#L18-L32>)

Bots the core structure for this system.  They are ephemeral and build from the Bot Group data, and store minimal data.  Bots are expected to be added or removed at any time, and there is a Timeout for Stale, Invalid, and Removed bots.

All Bots are expected to get all the data specified from the Bot Group in their Query to Variable mapping.

If a Bot is missing any data for it's variables, it is considered Invalid, because we are not operating with a full set of data.

```go
type Bot struct {
    Name                 string                   // Unique identifier pulled from the BotGroup.BotExtractor
    VariableValues       map[string]float64       // These are the unique values for this Bot, and will be used for all ActionConsideration scoring
    SortedVariableValues PairFloat64List          // Sorted VariableValues, Handlebars helper
    StateValues          []string                 // These are the current States for this Bot.  Actions can only be available for execution, if all their Action.RequiredStates are active in the Bot
    CommandHistory       []ActionCommandResult    // Storage of previous ActionCommand data run, so we can see insight into the history
    LockTimers           []BotLockTimer           // LockTimers allow control over Actions that require them, so they cant be available until they can get all their LockTimers
    ActionData           map[string]BotActionData // Key is Action.Name
    SortedActionData     PairBotActionDataList    // Scored ActionData, Handlebars helper
    FreezeActions        bool                     // If true, no actions will be taken for this Bot.  Single agent control
    IsInvalid            bool                     // If true, this Bot is Invalid and cannot make actions, because not all the Variables were found
    InfoInvalid          string                   // Short sentences ending with ".  " concatenated into this string to give all the reasons this Bot.IsInvalid
    IsStale              bool                     // If true, this Bot is Stale, and cannot make decisions.  IsInvalid is the super-state, and will be marked from this sub-reason for invalidity
    AccessLock           sync.RWMutex             // Lock for accessing maps.  Keeping the locks local means less contention
}
```

## type [BotActionData](<https://github.com/ghowland/sireus/blob/main/code/data/bot_data.go#L38-L46>)

This stores the Final Scores and related data for all Actions, so they can be compared to determin if any Action should be executed

```go
type BotActionData struct {
    FinalScore                   float64            // Final Score is the total result of calculations to Score this action for execution
    IsAvailable                  bool               // This Action is Available (not blocked) if the FinalScore is over the WeightThreshold
    AvailableStartTime           time.Time          // Time IsAvailable started, so we can use it for an internal Evaluation variable "_available_start_time".  Stateful.
    LastExecutedActionTime       time.Time          // Last time we executed this Action.  Stateful.
    Details                      []string           // Details about the Evaluation and Scoring, to make it easier to understand the result
    ConsiderationFinalScores     map[string]float64 // Considerations Final Results for this Bot
    ConsiderationEvaluatedScores map[string]float64 // Considerations Evaluated score, but not weighted results for this Bot
}
```

## type [BotExtractorQueryKey](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L41-L44>)

This is how Bots are created.  There is a BotQuery named QueryName that will use the Key to find the name of the Bots.  Using something like "instance", "node" or "service" is recommended, that will uniquely identify a Bot inside a BotGroup's configuration.

```go
type BotExtractorQueryKey struct {
    QueryName string `json:"query_name"`
    Key       string `json:"key"`
}
```

## type [BotForwardSequenceState](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L58-L62>)

Forward Sequence State is the term I am using to describe a State Machine that only has a single forward sequence.  It can be Advanced and it can be Reset, but the state cannot go backwards.

In this way you can create a State Machine for investigating problems, trying to solve them, checking for resolution, and finally escalating and waiting for someone else to fix it.

If a resolution is detected by an Action, the action can Reset this state, starting the States process over again.

States are used to exclude Actions from being tested, so that Actions can be targetted at a specific State of a Bot's operation.  This allows segmenting logic.  Actions use Action.RequiredStates to limit when they can execute.

```go
type BotForwardSequenceState struct {
    Name   string   `json:"name"`
    Info   string   `json:"info"`
    Labels []string `json:"labels"`
}
```

## type [BotGroup](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L10-L34>)

BotGroup is used to create Bots.  Bots are the core of Sireus.  BotGroups define all the information used to populate the ephemeral Bot structure.

```go
type BotGroup struct {
    Name                   string                    `json:"name"`
    Info                   string                    `json:"info"`
    BotExtractor           BotExtractorQueryKey      `json:"bot_extractor"`             // This is the information we use to create the ephemeral Bots, but taking their names from this query's metric key
    States                 []BotForwardSequenceState `json:"states"`                    // States can only advance from the start to the end, they can never go backwards.  It's a sequence, but you can skip steps forward.  Using several of these, many situations can be modelled.
    LockTimers             []BotLockTimer            `json:"lock_timers"`               // Lock timers work at BotGroup or Bot level, and block any execution for a period of time, so the previous action's results can be evaluated
    BotTimeoutStale        Duration                  `json:"bot_timeout_stale"`         // Duration since Bot.VariableValues was last updated until this Bot is marked as Stale.  Stale bots only execute Actions from a State named "Stale", so that you can respond, but no other states actions will apply.
    BotTimeoutRemove       Duration                  `json:"bot_timeout_remove"`        // Duration since Bot.VariableValues was last updated until this bot is removed.  Bots are ephemeral.
    BotRemoveStoreDuration Duration                  `json:"bot_remove_store_duration"` // Duration since removal that a Bot is stored for inspection, so that you don't lose access to useful information.  If the bot returns before this duration is over, it will be resumed.  Resumption can be refused setting BotGroup.RefuseBotResumption
    RefuseBotResumption    bool                      `json:"refuse_bot_resumption"`     // If true, once a bot is removed, while it is being stored for inspect, if it returns it will not be resumed.  Instead a new bot will be created to disconnect their history, even though they share the same BotKey
    ActionThreshold        float64                   `json:"action_threshold"`          // Minimum Action Final Score to execute a command.  Allows ignoring lower scoring Actions for testing or troubleshooting
    CommandHistoryDuration Duration                  `json:"command_history_duration"`  // How long we keep history for ActionCommandResult values
    JournalRollupStates    []string                  `json:"journal_rollup_states"`     // If any of these states become Active, then they will be rolled up into Journal collection, example: Outage Report
    JournalRollupDuration  Duration                  `json:"journal_rollup_duration"`   // Time between a Journal Rollup ending, and another Journal Rollup beginning, so that they are grouped together.  This collects flapping outages together.
    Queries                []BotQuery                `json:"queries"`                   // Queries used to populate the Variables
    Variables              []BotVariable             `json:"variables"`                 // Variables get their data from Queries, and are used in ActionConsideration evaluations to score the Action
    Actions                []Action                  `json:"actions"`                   // Actions get scored using ActionConsideration and the highest scored Action that IsAvailable will be executed.  Excecution also requires no LockTimers or other blocking factors.  The biggest factor is that Actions only are tested and execute when certain BotStates are set, so there is a built-in grouping of available Actions based on the BotState.
    Bots                   []Bot                     // These are the ephemeral workers of Sireus.  In an Action, the Queries populate VariableValues and then the ActionConsiderations are scored to determine if an action IsAvailable.

    // Invalid = Isn't getting all the information.  Stale = Information out of data.  Removed = No data for too long, removing.
    InvalidBots   []string
    StaleBots     []string
    RemovedBots   []string
    FreezeActions bool // If true, no actions will be taken for this BotGroup.  Allows group level control.
}
```

## type [BotLockTimer](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L124-L131>)

BotLockTimer is used to both block an Action from being executed, if the BotLockTimer.IsActive and has not reached the Timeout yet.  Actions can use multiple BotLockTimers which essentially act as execution "channels" where Actions execute 1 at a time.

BotLockTimeType specifies the scope of the lock.  Is it locked at the Bot level or the BotGroup level? BotGroup level locks \(LockBotGroup\) are essentially global level locks, as BotGroups do not interact with each other, as they are data silos for decision\-making.

```go
type BotLockTimer struct {
    Type           BotLockTimerType `json:"type"`
    Name           string           `json:"name"`
    Info           string           `json:"info"`
    IsActive       bool
    Timeout        time.Time
    ActivatedByBot string // Bot.Name of who set this Lock Timer, so we can track Actions
}
```

## type [BotLockTimerType](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L97>)

Scope for locking Actions

```go
type BotLockTimerType int64
```

```go
const (
    LockBotGroup BotLockTimerType = iota
    LockBot
)
```

### func \(BotLockTimerType\) [String](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L106>)

```go
func (bltt BotLockTimerType) String() string
```

Format the BotLockTimerType for human readability

## type [BotQuery](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L85-L92>)

These queries are stored in BotGroup, but are used to populate the Bots with query Variables.

```go
type BotQuery struct {
    QueryServer string       `json:"query_server"`
    QueryType   BotQueryType `json:"query_type"`
    Name        string       `json:"name"`
    Info        string       `json:"info"`
    Query       string       `json:"query"`
    Interval    Duration     `json:"interval"`
}
```

## type [BotQueryType](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L67>)

Differentiate Query Types, so we can format our requests and parse the data properly

```go
type BotQueryType int64
```

```go
const (
    Range BotQueryType = iota
)
```

### func \(BotQueryType\) [String](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L75>)

```go
func (bqt BotQueryType) String() string
```

Format the BotQueryType to a string usable for building the request

## type [BotVariable](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L190-L203>)

BotVariable is what is used for the ActionConsideration scoring process.

BotVariable is assigned in the BotGroup, which is the definition of what will be queried or synthesized into each Bot.

If Evaluate is not empty, then this will not run a Query, and instead will execute after all Query Variables are set, and will Evalutate using govaluate.Evaluate\(\) to set a new variable.

Otherwise, a query is performed, and the variable is set from the query.

Query Variables use any combination of BotKey, QueryKey and QueryKeyValue to set the variables.

If BotKey is set, only query results that have a Metric Key named BotKey that matches Bot.Name will be accepted.

If QueryKey is set, only query results that have a value with their Metric Name of QueryKey which matches QueryKeyValue will be set.

```go
type BotVariable struct {
    Type           BotVariableType   `json:"type"`
    Name           string            `json:"name"`
    Format         BotVariableFormat `json:"format"`
    BotKey         string            `json:"bot_key"` // Determines which Metric matches a Bot, may change between queries
    QueryName      string            `json:"query_name"`
    QueryKey       string            `json:"query_key"`       // Metric key to extract
    QueryKeyValue  string            `json:"query_key_value"` // Metric key value to match against the QueryKey
    Evaluate       string            `json:"evaluate"`        // If this is non-empty, query will not be performed.  After query testing for other variables, this will have a final phase of processing, and will take all the query-made variables and perform govaluation.Evaluate() with this evaluate string, to set this variable.  Evaluate variables cannot use each other, only Query variables.
    BoolRangeStart float64           `json:"bool_range_start"`
    BoolRangeEnd   float64           `json:"bool_range_end"`
    BoolInvert     bool              `json:"bool_invert"`
    Export         bool              `json:"export"` // If true, this variable will be exported for Metric collection.  Normally not useful, because we just got it from the Metric system.
}
```

## type [BotVariableFormat](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L146>)

This is for formatting the data we got raw from BotVariableType.  This uses Humanize and other readability funcs

```go
type BotVariableFormat int64
```

```go
const (
    FormatFloat BotVariableFormat = iota
    FormatBool
    FormatBytes
    FormatBandwidth
    FormatTime
    FormatDuration
    FormatPercent
    FormatOrdinal
    FormatComma
    FormatMetricPrefix
)
```

## type [BotVariableType](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L136>)

This is the raw input data type.  It will still be turned into a float64, but it is best to know the origin type

```go
type BotVariableType int64
```

```go
const (
    Boolean BotVariableType = iota
    Float
)
```

### func \(BotVariableType\) [String](<https://github.com/ghowland/sireus/blob/main/code/data/bot_group_data.go#L163>)

```go
func (bvt BotVariableType) String() string
```

Format the BotVariableType for human readability

## type [Duration](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L45>)

Cant unmarshal JSON into time.Duration, so wrapping it

```go
type Duration time.Duration
```

### func \(Duration\) [MarshalJSON](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L49>)

```go
func (d Duration) MarshalJSON() ([]byte, error)
```

Marshal JSON for our time.Duration wrapper

### func \(\*Duration\) [UnmarshalJSON](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L54>)

```go
func (d *Duration) UnmarshalJSON(b []byte) error
```

Unmarshal JSON for our time.Duration wrapper

## type [InteractiveControl](<https://github.com/ghowland/sireus/blob/main/code/data/interactive_data.go#L76-L84>)

InteractiveControl comes from the Web App as JSON data on each RPC call, to update what data we want returned

```go
type InteractiveControl struct {
    SessionUUID            SessionUUID `json:"sessionUUID"`            // Interactive Session UUID
    UseInteractiveSession  bool        `json:"useInteractiveSession"`  // If true, we will use all the Interactive session data.  If false, this will use normal production data.
    UseInteractiveOverride bool        `json:"useInteractiveOverride"` // If true, we will use the state and variable overrides.  If false, we can still use Query Time for interactive session, but will not use override states and vars
    PlayForward            bool        `json:"playForward"`            // Should we move the Scrubber forward as we return data?
    QueryStartTime         float64     `json:"queryStartTime"`         // When should the Interactive query start?
    QueryDuration          float64     `json:"queryDuration"`          // Duration from the Query Start, creates the Query End
    QueryScrubTime         float64     `json:"queryScrubTime"`         // This is where the Scrubbed currently is, so use this data from the metrics data
}
```

## type [InteractiveSession](<https://github.com/ghowland/sireus/blob/main/code/data/interactive_data.go#L23-L31>)

An InteractiveSession is created when a Web App user wants to look at how their Actions would score at a previous time, or if there were different Bot.VariableValues or an Action.Weight or ActionConsideration was different

```go
type InteractiveSession struct {
    UUID           SessionUUID `json:"uuid"`             // This is the unique identifier for this InteractiveSession, and cannot be 0.  0 is used by the normal server processes for performing queries.
    TimeRequested  time.Time   `json:"time_requested"`   // This is the last time we received a request from this InteractiveSession.  When it passes the AppConfig.InteractiveSessionTimeout duration it will be removed
    QueryStartTime time.Time   `json:"query_start_time"` // Time to make all our queries, so that we can interactively look into past data and reply how actions would be scored with the current config (base and OverrideData)
    QueryDuration  Duration    `json:"query_duration"`   // Duration to query past QueryStartTime
    QueryScrubTime time.Time   `json:"query_scrub_time"` // Time our Scrubber is currently on.  Somewhere between QueryStartTime and QueryStartTime + QueryDuration
    Override       Override    `json:"overrides"`        // This is a collection of data we get from the Web Client that overrides internal or queried data.  Over
    BotGroups      []BotGroup  // These are the BotGroups we create and cache for this Session
}
```

## type [InteractiveSessionPool](<https://github.com/ghowland/sireus/blob/main/code/data/interactive_data.go#L15-L18>)

Pool to keep our all InteractiveSession data.  This is used for normal production data too, with the UUID==0

```go
type InteractiveSessionPool struct {
    Sessions   map[SessionUUID]InteractiveSession // All our current InteractiveSession data, key on UUID, for tracking users testing scoring or config changes through the web app.  Will store an addition set of BotQuery items per BotGroup overridden
    AccessLock sync.RWMutex                       // Lock for safe goroutine access to Sesssions map
}
```

## type [Override](<https://github.com/ghowland/sireus/blob/main/code/data/interactive_data.go#L36-L40>)

This tracks all the override changes relating to BotGroups or Bots for an InteractiveSession

```go
type Override struct {
    BotGroups []OverrideBotGroup `json:"bot_groups"` // Overrides of BotGroup data: Action.Weight and ActionConsideration data
    Bots      []OverrideBot      `json:"bots"`       // Overrides of Bot data: Bot.VariableValues and Bot.StateValues
    States    []string           `json:"states"`     // Overrides of States.  Can only set 1 per state.  By default, all should be set, so we know where we are.
}
```

## type [OverrideActionConsideration](<https://github.com/ghowland/sireus/blob/main/code/data/interactive_data.go#L54-L62>)

Overrides for an ActionConsideration in an Action, for a BotGroup.  Changes all related Bot scores.  For simplicity, when making an ActionCconsideration override, all values are always updated.  No reason to have sparse changes here

```go
type OverrideActionConsideration struct {
    ActionName        string  `json:"action_name"`        // Name of the Action to modify.  There are many ActionConsideration per Action
    ConsiderationName string  `json:"consideration_name"` // Consideration name identifier
    Weight            float64 `json:"weight"`             // Overrides ActionConsideration.Weight
    CurveName         string  `json:"curve_name"`         // Overrides ActionConsideration.CurveName
    RangeStart        float64 `json:"range_start"`        // Overrides ActionConsideration.RangeStart
    RangeEnd          float64 `json:"range_end"`          // Overrides ActionConsideration.RangeEnd

}
```

## type [OverrideBot](<https://github.com/ghowland/sireus/blob/main/code/data/interactive_data.go#L67-L71>)

Overrides to a Bot for an InteractiveSession

```go
type OverrideBot struct {
    Name           string             `json:"name"`            // Name of the Bot to override.  This scope is Bot level
    VariableValues map[string]float64 `json:"variable_values"` // The Bot.VariableValues that are being overridden.  This is useful to see how Action scores would change if some monitoring data was different, without having to find a time in the past where that was true.  Allows planning for different situations.
    StateValues    []string           `json:"state_values"`    // If this is not an empty list, then it will override the specified BotGroup.States for this Bot.  This allows testing different Action scores in any state.
}
```

## type [OverrideBotGroup](<https://github.com/ghowland/sireus/blob/main/code/data/interactive_data.go#L45-L49>)

Overrides to a BotGroup for an InteractiveSession

```go
type OverrideBotGroup struct {
    BotGroupName         string                        `json:"name"`                  // Name of the Bot to override.  This scope is Bot level
    ActionWeight         map[string]float64            `json:"action_weight"`         // Overrides an Action.Weight for all the Bots in this BotGroup.  Changes Action scores for all Bots in a BotGroup
    ActionConsiderations []OverrideActionConsideration `json:"action_considerations"` // Overrides ActionConsideration values for all Bots in this BotGroup
}
```

## type [PairBotActionData](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L29-L32>)

Allows for sorting BotActionData by FinalScore

```go
type PairBotActionData struct {
    Key   string
    Value BotActionData
}
```

## type [PairBotActionDataList](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L35>)

```go
type PairBotActionDataList []PairBotActionData
```

### func \(PairBotActionDataList\) [Len](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L37>)

```go
func (p PairBotActionDataList) Len() int
```

### func \(PairBotActionDataList\) [Less](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L38>)

```go
func (p PairBotActionDataList) Less(i, j int) bool
```

### func \(PairBotActionDataList\) [Swap](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L41>)

```go
func (p PairBotActionDataList) Swap(i, j int)
```

## type [PairFloat64](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L11-L15>)

Allows for sorting map\[string\]float64 by value or key, and also stores a human readable formatted string

```go
type PairFloat64 struct {
    Key       string
    Value     float64
    Formatted string
}
```

## type [PairFloat64List](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L20>)

Wrapper for PairFloat64 that makes sorting possible

```go
type PairFloat64List []PairFloat64
```

### func \(PairFloat64List\) [Len](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L23>)

```go
func (p PairFloat64List) Len() int
```

### func \(PairFloat64List\) [Less](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L24>)

```go
func (p PairFloat64List) Less(i, j int) bool
```

### func \(PairFloat64List\) [Swap](<https://github.com/ghowland/sireus/blob/main/code/data/fix_go_data.go#L25>)

```go
func (p PairFloat64List) Swap(i, j int)
```

## type [PrometheusResponse](<https://github.com/ghowland/sireus/blob/main/code/data/prometheus_data.go#L23-L28>)

Response from Prometheus.  I made a short\-hand version of this instead of using the one from Prometheus for convenience.

```go
type PrometheusResponse struct {
    Status       string                 `json:"status"`
    Data         PrometheusResponseData `json:"data"`
    RequestTime  time.Time              // When the Request was made
    ResponseTime time.Time              // When the Response was received
}
```

## type [PrometheusResponseData](<https://github.com/ghowland/sireus/blob/main/code/data/prometheus_data.go#L15-L18>)

Payload for PrometheusResponse

```go
type PrometheusResponseData struct {
    ResultType string                         `json:"resultType"`
    Result     []PrometheusResponseDataResult `json:"result"`
}
```

## type [PrometheusResponseDataResult](<https://github.com/ghowland/sireus/blob/main/code/data/prometheus_data.go#L7-L10>)

Data inside the payload of the PrometheusResponseData

```go
type PrometheusResponseDataResult struct {
    Metric map[string]string `json:"metric"`
    Values [][]interface{}   `json:"values"`
}
```

## type [QueryResult](<https://github.com/ghowland/sireus/blob/main/code/data/query_server_data.go#L70-L75>)

A single Query result

```go
type QueryResult struct {
    QueryServer        string             // Server this Query came from.  These are stored in Site.QueryServers
    QueryType          BotQueryType       // Type of the query, for formatting the API request
    Query              string             // The Query.  We cache off this, so any repeats into the same QueryServer are shared
    PrometheusResponse PrometheusResponse // The Response.  TODO(ghowland): Abstract this for N data sources
}
```

## type [QueryResultPool](<https://github.com/ghowland/sireus/blob/main/code/data/query_server_data.go#L47-L52>)

QueryResultPool is the cache for all BotGroup.Queries.  It contains normal BotQuery results from intervals, and special InteractiveUUID versions of the results, so that users can request the same query from a different time to test their Action scoring

```go
type QueryResultPool struct {
    QueryPoolSyncLock  sync.RWMutex                   // Sync Lock for PoolItems, to read or write, first obtain this lock for goroutine safety
    PoolItems          map[string]QueryResultPoolItem // These are all the items in our pool.  When we get a data request (web or internal), we get the result from here, if it exists.  New queries are run in the background and then their lateste results go here
    QueryLocksSyncLock sync.RWMutex                   // Sync Lock for QueryLocks, to read or write, first obtain this lock for goroutine safety
    QueryLocks         map[string]time.Time           // Key="(QueryServer.Name).(BotQuery.name)" Time this query was made, so we don't make it again until it finishes and clears this lock (time.Unix(0,0)) or AppConfig.QueryLockTimeout expires and we clear it.  TODO(ghowland): Use a Context wrapper here instead and then I can cancel any wedged query?
}
```

## type [QueryResultPoolItem](<https://github.com/ghowland/sireus/blob/main/code/data/query_server_data.go#L57-L65>)

An entry in QueryResultPool with a single BotQuery result for a BotGroup.  These can be normal queries \(InteractiveUUID==0\) that take current monitoring results, or from an InteractiveSession where the InteractiveSession.QueryTime is in the past

```go
type QueryResultPoolItem struct {
    QueryServer     string      // Server to make the query, from Site.QueryServers
    Query           string      // Share Query results by only testing the Query and QueryServer for matching stored queries.  All BotGroups will share results, and the shorter BotQuery.Interval will set the query pace
    InteractiveUUID SessionUUID // This is 0 for normal server operation, but when a user wants to look at alternative time queries, this is set to their InteractiveUUID
    TimeRequested   time.Time   // Time the BotQuery was requested
    TimeReceived    time.Time   // Time the Response was received
    Result          QueryResult // Response from the QueryServer
    IsValid         bool        // Is the response valid?  If false, it can't be used
}
```

## type [QueryServer](<https://github.com/ghowland/sireus/blob/main/code/data/query_server_data.go#L14-L25>)

QueryServer is where we connect to get data to populate our Bots.  example: Prometheus These are stored at a Site level, so that they can be shared by all BotGroups in a Site.

Inside a QueryServer, all QueryNames must be unique for any BotGroup, so that they can potentially be shared to reduce QueryServer traffic.  Keep this in mind when creating BotGroup.Queries.

```go
type QueryServer struct {
    ServerType          QueryServerType `json:"server_type"`
    Name                string          `json:"name"`
    Info                string          `json:"info"`
    Host                string          `json:"host"`
    Port                int             `json:"port"`
    AuthUser            string          `json:"auth_user"`
    AuthSecret          string          `json:"auth_secret"`
    DefaultStep         string          `json:"default_step"`
    DefaultDataDuration Duration        `json:"default_data_duration"`
    WebUrlFormat        string          `json:"web_url_format"`
}
```

## type [QueryServerType](<https://github.com/ghowland/sireus/blob/main/code/data/query_server_data.go#L29>)

QueryServerType specifies QueryServer software, defining how we make and parse Query requests

```go
type QueryServerType int64
```

```go
const (
    Prometheus QueryServerType = iota
)
```

### func \(QueryServerType\) [String](<https://github.com/ghowland/sireus/blob/main/code/data/query_server_data.go#L37>)

```go
func (qst QueryServerType) String() string
```

Format the QueryServerType for human readability

## type [SessionUUID](<https://github.com/ghowland/sireus/blob/main/code/data/interactive_data.go#L10>)

Our session UUID.  UUID==0 is production data queried now.  UUID\!=0 is interactive session with modified query and result data.

```go
type SessionUUID int64
```

## type [SireusServerData](<https://github.com/ghowland/sireus/blob/main/code/data/server_data.go#L10-L16>)

SireusServerData is Singleton structure for keeping global state

```go
type SireusServerData struct {
    AppConfig     AppConfig       // App Server configuration
    Site          Site            // For now, only 1 Site.  Later this will be dynamic
    IsQuitting    bool            // When true, this server is quitting and everything will shut down.  Controls RunUntilContextCancelled()
    ServerContext context.Context // Context to quickly cancel all activities
    ServerLock    sync.RWMutex    // For making changes to the server where we need to lock
}
```

## type [Site](<https://github.com/ghowland/sireus/blob/main/code/data/site_data.go#L6-L16>)

Top Level of the data structure.  Site silos all BotGroups and QueryServers, so that we can have multiple Sites which are using different data sets, and should not share any data with each other.

```go
type Site struct {
    Name                    string                 `json:"name"`            // Site name.  Full silo for QueryServers and BotGroups
    Info                    string                 `json:"info"`            // Description
    BotGroupPaths           []string               `json:"bot_group_paths"` // Paths to bot_group_name.json configs
    QueryServers            []QueryServer          `json:"query_servers"`   // List of QueryServers for making BotQuery requests
    FreezeActions           bool                   // If true, no actions will be taken for this Site.  Allows control of all BotGroups Action execution.
    QueryResultCache        QueryResultPool        // Per Site, we cache all the BotQuery results here.  Per normal server operation, and per InteractiveSession
    InteractiveSessionCache InteractiveSessionPool // Per Site, we track web app InteractiveSession data to allow users to make changes and see how they alter the Action scoring.  Sites silo everything, so it would be an anti-feature to allow InteractiveSession data to cross Site boundarie
    LoadedBotGroups         []BotGroup             // These are just JSON loaded values to be cloned for the InteractiveSesssion.BotGroups, which contain Bots which perform the Action scoring in the active States
    ProductionControl       InteractiveControl     // This is the config loaded production (UUID=0) version of InteractiveControl.  Storing it here means it doesn't have to keep being generated when needed.
}
```

# extdata

```go
import "github.com/ghowland/sireus/code/extdata"
```

## Index

- [func CreateFormattedVariables(session *data.InteractiveSession, site *data.Site, botGroupIndex int)](<#func-createformattedvariables>)
- [func ExtractBotsFromPromData(response data.PrometheusResponse, botKey string) []data.Bot](<#func-extractbotsfrompromdata>)
- [func GetBotEvalMapAllVariables(bot *data.Bot) map[string]interface{}](<#func-getbotevalmapallvariables>)
- [func GetBotEvalMapOnlyQueries(bot data.Bot, queryVariableNames []string) map[string]interface{}](<#func-getbotevalmaponlyqueries>)
- [func GetCachedQueryResult(session *data.InteractiveSession, site *data.Site, query data.BotQuery, errorOverInterval bool) (data.QueryResult, error)](<#func-getcachedqueryresult>)
- [func GetQueryKey(session *data.InteractiveSession, query data.BotQuery) string](<#func-getquerykey>)
- [func InitializeStates(session *data.InteractiveSession, botGroupIndex int)](<#func-initializestates>)
- [func IsQueryLocked(session *data.InteractiveSession, site *data.Site, query data.BotQuery) bool](<#func-isquerylocked>)
- [func QueryCacheSet(session *data.InteractiveSession, site *data.Site, query data.BotQuery, newCacheItem data.QueryResultPoolItem)](<#func-querycacheset>)
- [func QueryLockClear(site *data.Site, queryKey string)](<#func-querylockclear>)
- [func QueryLockSet(site *data.Site, queryKey string)](<#func-querylockset>)
- [func QueryPrometheus(host string, port int, queryType data.BotQueryType, query string, timeStart time.Time, duration int) data.PrometheusResponse](<#func-queryprometheus>)
- [func SortAllVariablesAndActions(session *data.InteractiveSession, site *data.Site, botGroupIndex int)](<#func-sortallvariablesandactions>)
- [func StoreQueryResult(session *data.InteractiveSession, site *data.Site, query data.BotQuery, startTime time.Time, queryResult data.QueryResult)](<#func-storequeryresult>)
- [func UpdateBotActionConsiderations(session *data.InteractiveSession, site *data.Site, botGroupIndex int)](<#func-updatebotactionconsiderations>)
- [func UpdateBotGroupFromPrometheus(session *data.InteractiveSession, site *data.Site, botGroupIndex int)](<#func-updatebotgroupfromprometheus>)
- [func UpdateBotsFromQueries(session *data.InteractiveSession, site *data.Site, botGroupIndex int)](<#func-updatebotsfromqueries>)
- [func UpdateBotsWithSyntheticVariables(session *data.InteractiveSession, site *data.Site, botGroupIndex int)](<#func-updatebotswithsyntheticvariables>)
- [func UpdateSiteBotGroups(session *data.InteractiveSession)](<#func-updatesitebotgroups>)


## func [CreateFormattedVariables](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L40>)

```go
func CreateFormattedVariables(session *data.InteractiveSession, site *data.Site, botGroupIndex int)
```

Create formatted variables for all our Bots.  This adds human\-readable strings to all the sorted Pair Lists

## func [ExtractBotsFromPromData](<https://github.com/ghowland/sireus/blob/main/code/extdata/prometheus.go#L42>)

```go
func ExtractBotsFromPromData(response data.PrometheusResponse, botKey string) []data.Bot
```

Extract our ephemeral Bots from the Prometheus response, using the BotKey extractor information

## func [GetBotEvalMapAllVariables](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L249>)

```go
func GetBotEvalMapAllVariables(bot *data.Bot) map[string]interface{}
```

Returns the map for doing the Evaluate with a Bots VariableValues.  Uses Govaluate.Evaluate\(\) NOTE\(ghowland\): bot.AccessLock should already be locked before we come here, because we are accessing a map

## func [GetBotEvalMapOnlyQueries](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L233>)

```go
func GetBotEvalMapOnlyQueries(bot data.Bot, queryVariableNames []string) map[string]interface{}
```

Returns the map for doing the Evaluate against a Query to create our Scores.  Uses Govaluate.Evaluate\(\) NOTE\(ghowland\): bot.AccessLock should already be locked before we come here, because we are accessing a map

## func [GetCachedQueryResult](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_query.go#L29>)

```go
func GetCachedQueryResult(session *data.InteractiveSession, site *data.Site, query data.BotQuery, errorOverInterval bool) (data.QueryResult, error)
```

GetCachedQueryResult returns a cached query result.  Web App requests should set errorOverInterval=false, which is used by the background query system to test missing or expired query results as equivalent.

## func [GetQueryKey](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_query.go#L87>)

```go
func GetQueryKey(session *data.InteractiveSession, query data.BotQuery) string
```

GetQueryKey returns "\(QueryServer\).\(Query\)", so it can be shared by any BotGroup

## func [InitializeStates](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L289>)

```go
func InitializeStates(session *data.InteractiveSession, botGroupIndex int)
```

Initialize all the States for this BotGroup's Bots.   They should all start at the first state value, and only move forward or reset.

## func [IsQueryLocked](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_query.go#L94>)

```go
func IsQueryLocked(session *data.InteractiveSession, site *data.Site, query data.BotQuery) bool
```

IsQueryLocked returned whether this Query currently being requested.  Don't want to request more than once at a time

## func [QueryCacheSet](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_query.go#L57>)

```go
func QueryCacheSet(session *data.InteractiveSession, site *data.Site, query data.BotQuery, newCacheItem data.QueryResultPoolItem)
```

## func [QueryLockClear](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_query.go#L68>)

```go
func QueryLockClear(site *data.Site, queryKey string)
```

QueryLockClear will clear the Query Lock, so we can make this Query again after the Interval

## func [QueryLockSet](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_query.go#L78>)

```go
func QueryLockSet(site *data.Site, queryKey string)
```

QueryLockSet will set the Query Lock for a QueryKey, so we won't request this Query again until it finishes or the AppConfig.QueryLockTimeout expires

## func [QueryPrometheus](<https://github.com/ghowland/sireus/blob/main/code/extdata/prometheus.go#L15>)

```go
func QueryPrometheus(host string, port int, queryType data.BotQueryType, query string, timeStart time.Time, duration int) data.PrometheusResponse
```

Query the Prometheus metric server

## func [SortAllVariablesAndActions](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L63>)

```go
func SortAllVariablesAndActions(session *data.InteractiveSession, site *data.Site, botGroupIndex int)
```

Sort all the Variables by name and Actions by Final Score

## func [StoreQueryResult](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_query.go#L11>)

```go
func StoreQueryResult(session *data.InteractiveSession, site *data.Site, query data.BotQuery, startTime time.Time, queryResult data.QueryResult)
```

StoreQueryResult will store a QueryResult in the cache

## func [UpdateBotActionConsiderations](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L87>)

```go
func UpdateBotActionConsiderations(session *data.InteractiveSession, site *data.Site, botGroupIndex int)
```

For this BotGroup, update all the BotActionData with new ActionConsideration scores

## func [UpdateBotGroupFromPrometheus](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L261>)

```go
func UpdateBotGroupFromPrometheus(session *data.InteractiveSession, site *data.Site, botGroupIndex int)
```

Runs Queries against Prometheus for a BotGroup

## func [UpdateBotsFromQueries](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L301>)

```go
func UpdateBotsFromQueries(session *data.InteractiveSession, site *data.Site, botGroupIndex int)
```

Update all the Bot VariableValues from our Queries

## func [UpdateBotsWithSyntheticVariables](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L178>)

```go
func UpdateBotsWithSyntheticVariables(session *data.InteractiveSession, site *data.Site, botGroupIndex int)
```

Update bot with Synthetic Variables.  Happens after all the Query Variables are set.  Synthetic vars can't work on each other

## func [UpdateSiteBotGroups](<https://github.com/ghowland/sireus/blob/main/code/extdata/site_update.go#L16>)

```go
func UpdateSiteBotGroups(session *data.InteractiveSession)
```

Update all the BotGroups in this Site

# fixgo

```go
import "github.com/ghowland/sireus/code/fixgo"
```

## Index

- [func SortMapStringFloat64ByKey(input map[string]float64) data.PairFloat64List](<#func-sortmapstringfloat64bykey>)
- [func SortMapStringFloat64ByValue(input map[string]float64, sortForward bool) data.PairFloat64List](<#func-sortmapstringfloat64byvalue>)


## func [SortMapStringFloat64ByKey](<https://github.com/ghowland/sireus/blob/main/code/fixgo/fix_go_sort.go#L9>)

```go
func SortMapStringFloat64ByKey(input map[string]float64) data.PairFloat64List
```

Sort a map\[string\]float64 by their key.  Returns a custom pair list

## func [SortMapStringFloat64ByValue](<https://github.com/ghowland/sireus/blob/main/code/fixgo/fix_go_sort.go#L32>)

```go
func SortMapStringFloat64ByValue(input map[string]float64, sortForward bool) data.PairFloat64List
```

Sort a map\[string\]float64 by their value.  Returns a custom pair list TODO\(ghowland\):PERF: Inefficient, but I am working quickly.  Make it better later.

# server

```go
import "github.com/ghowland/sireus/code/server"
```

## Index

- [func BackgroundQuery(session *data.InteractiveSession, site *data.Site, query data.BotQuery)](<#func-backgroundquery>)
- [func Configure()](<#func-configure>)
- [func GetServerBackgroundContext() context.Context](<#func-getserverbackgroundcontext>)
- [func LoadConfig()](<#func-loadconfig>)
- [func RunAllSiteQueries(session *data.InteractiveSession, site *data.Site)](<#func-runallsitequeries>)
- [func RunForever()](<#func-runforever>)


## func [BackgroundQuery](<https://github.com/ghowland/sireus/blob/main/code/server/server.go#L109>)

```go
func BackgroundQuery(session *data.InteractiveSession, site *data.Site, query data.BotQuery)
```

Query in the background with a goroutine

## func [Configure](<https://github.com/ghowland/sireus/blob/main/code/server/server.go#L18>)

```go
func Configure()
```

## func [GetServerBackgroundContext](<https://github.com/ghowland/sireus/blob/main/code/server/server.go#L38>)

```go
func GetServerBackgroundContext() context.Context
```

Get the global Server context, so that we can cancel everything in progress

## func [LoadConfig](<https://github.com/ghowland/sireus/blob/main/code/server/server.go#L28>)

```go
func LoadConfig()
```

Load and reload config.  Will set ServerLock so this is safe to do

## func [RunAllSiteQueries](<https://github.com/ghowland/sireus/blob/main/code/server/server.go#L91>)

```go
func RunAllSiteQueries(session *data.InteractiveSession, site *data.Site)
```

Requests all the Queries in all the BotGroups, if they are missing or past their freshness Interval. Requests are not cleared, so the data will stay available for the Web App, but after the BotGroup.BotTimeoutStale Actions are not available.

## func [RunForever](<https://github.com/ghowland/sireus/blob/main/code/server/server.go#L62>)

```go
func RunForever()
```

Run forever, until we stop the server

# util

```go
import "github.com/ghowland/sireus/code/util"
```

## Index

- [Variables](<#variables>)
- [func BoolToFloatString(value bool) string](<#func-booltofloatstring>)
- [func Check(e error) bool](<#func-check>)
- [func CheckNoLog(e error) bool](<#func-checknolog>)
- [func CheckPanic(e error)](<#func-checkpanic>)
- [func Clamp(value float64, min float64, max float64) float64](<#func-clamp>)
- [func ConvertInterfaceToFloat(value interface{}) (float64, error)](<#func-convertinterfacetofloat>)
- [func FileExists(filename string) bool](<#func-fileexists>)
- [func FileLoad(path string) (string, error)](<#func-fileload>)
- [func FormatTimeLong(t time.Time) string](<#func-formattimelong>)
- [func HandlebarFormatData(format string, mapData map[string]interface{}) string](<#func-handlebarformatdata>)
- [func HandlebarFormatText(format string, mapData map[string]string) string](<#func-handlebarformattext>)
- [func HandlebarsRegisterPartials(partialsDirPrefix string, removeBasePath string, template *raymond.Template)](<#func-handlebarsregisterpartials>)
- [func ParseContextBody(c *fiber.Ctx) map[string]string](<#func-parsecontextbody>)
- [func PrintJson(value interface{}) string](<#func-printjson>)
- [func PrintJsonData(value interface{}) string](<#func-printjsondata>)
- [func PrintStringArrayCSV(slice []string) string](<#func-printstringarraycsv>)
- [func RangeMapper(value float64, rangeMin float64, rangeMax float64) float64](<#func-rangemapper>)
- [func StringInSlice(a string, list []string) bool](<#func-stringinslice>)


## Variables

```go
var (
    // Float64 is our primary data type, custom error for tracking problems
    InvalidTypeFloat64 = errors.New("Value could not be converted to Float64")
)
```

## func [BoolToFloatString](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L158>)

```go
func BoolToFloatString(value bool) string
```

Converts a boolean to a string of "0" or "1"

## func [Check](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L17>)

```go
func Check(e error) bool
```

Call Check when we only want to log the error and wrap error testing, but it does not require an exceptional response

## func [CheckNoLog](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L28>)

```go
func CheckNoLog(e error) bool
```

Call CheckNoLog when we want to get a boolean on the error, but dont want to log because we handle the response and it's too noisy or not useful.

## func [CheckPanic](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L37>)

```go
func CheckPanic(e error)
```

Call CheckPanic for configuration errors that can't be solved.

## func [Clamp](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L142>)

```go
func Clamp(value float64, min float64, max float64) float64
```

Clamp a value between a min and a max

## func [ConvertInterfaceToFloat](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L118>)

```go
func ConvertInterfaceToFloat(value interface{}) (float64, error)
```

Convert any value we can into a float64 in a predictable manner

## func [FileExists](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L45>)

```go
func FileExists(filename string) bool
```

Does this file exist?  Wrap to make code shorter in situ

## func [FileLoad](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L53>)

```go
func FileLoad(path string) (string, error)
```

## func [FormatTimeLong](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L189>)

```go
func FormatTimeLong(t time.Time) string
```

## func [HandlebarFormatData](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L92>)

```go
func HandlebarFormatData(format string, mapData map[string]interface{}) string
```

Format Handlebars string from data, so I don't have to remember any arguments

## func [HandlebarFormatText](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L63>)

```go
func HandlebarFormatText(format string, mapData map[string]string) string
```

Format Handlebars string from strings, so I don't have to remember any arguments

## func [HandlebarsRegisterPartials](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L70>)

```go
func HandlebarsRegisterPartials(partialsDirPrefix string, removeBasePath string, template *raymond.Template)
```

## func [ParseContextBody](<https://github.com/ghowland/sireus/blob/main/code/util/util_fiber_app.go#L9>)

```go
func ParseContextBody(c *fiber.Ctx) map[string]string
```

Parse the HTTP request body.  Needed for API requests

## func [PrintJson](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L167>)

```go
func PrintJson(value interface{}) string
```

Print JSON, for debugging

## func [PrintJsonData](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L175>)

```go
func PrintJsonData(value interface{}) string
```

Print JSON, for transport

## func [PrintStringArrayCSV](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L183>)

```go
func PrintStringArrayCSV(slice []string) string
```

Print a string array.  For human readability or debugging

## func [RangeMapper](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L147>)

```go
func RangeMapper(value float64, rangeMin float64, rangeMax float64) float64
```

Returns clamped value between 0\-1, where the value falls between the range

## func [StringInSlice](<https://github.com/ghowland/sireus/blob/main/code/util/util_common.go#L103>)

```go
func StringInSlice(a string, list []string) bool
```

Test if a string is in a slice

# webapp

```go
import "github.com/ghowland/sireus/code/webapp"
```

## Index

- [func BuildRenderMap(site *data.Site, botGroup data.BotGroup, bot data.Bot, inputData map[string]interface{}, interactiveControl data.InteractiveControl) map[string]interface{}](<#func-buildrendermap>)
- [func BuildRenderMapFiber(site *data.Site, botGroup data.BotGroup, bot data.Bot, inputData map[string]interface{}) fiber.Map](<#func-buildrendermapfiber>)
- [func CreateHandlebarsEngine(appConfig data.AppConfig) *handlebars.Engine](<#func-createhandlebarsengine>)
- [func CreateWebApp(engine *handlebars.Engine) *fiber.App](<#func-createwebapp>)
- [func FormatInteractiveStartTime() string](<#func-formatinteractivestarttime>)
- [func GetRenderMapFromParams(c *fiber.Ctx, site *data.Site) fiber.Map](<#func-getrendermapfromparams>)
- [func GetRenderMapFromRPC(c *fiber.Ctx, site *data.Site) map[string]interface{}](<#func-getrendermapfromrpc>)
- [func RegisterHandlebarsHelpers()](<#func-registerhandlebarshelpers>)
- [func RegisterHandlebarsHelpers_FormatData()](<#func-registerhandlebarshelpers_formatdata>)
- [func RegisterHandlebarsHelpers_GetAppData()](<#func-registerhandlebarshelpers_getappdata>)
- [func RegisterHandlebarsHelpers_IfArrayLength()](<#func-registerhandlebarshelpers_ifarraylength>)
- [func RegisterHandlebarsHelpers_IfTests()](<#func-registerhandlebarshelpers_iftests>)
- [func RegisterHandlebarsHelpers_WithData()](<#func-registerhandlebarshelpers_withdata>)


## func [BuildRenderMap](<https://github.com/ghowland/sireus/blob/main/code/webapp/params.go#L155>)

```go
func BuildRenderMap(site *data.Site, botGroup data.BotGroup, bot data.Bot, inputData map[string]interface{}, interactiveControl data.InteractiveControl) map[string]interface{}
```

## func [BuildRenderMapFiber](<https://github.com/ghowland/sireus/blob/main/code/webapp/params.go#L106>)

```go
func BuildRenderMapFiber(site *data.Site, botGroup data.BotGroup, bot data.Bot, inputData map[string]interface{}) fiber.Map
```

## func [CreateHandlebarsEngine](<https://github.com/ghowland/sireus/blob/main/code/webapp/app.go#L10>)

```go
func CreateHandlebarsEngine(appConfig data.AppConfig) *handlebars.Engine
```

Initial creation of the Handlebars engine, which is passed into Fiber

## func [CreateWebApp](<https://github.com/ghowland/sireus/blob/main/code/webapp/app.go#L31>)

```go
func CreateWebApp(engine *handlebars.Engine) *fiber.App
```

Create the Fiber web app, from the Handlebars engine

## func [FormatInteractiveStartTime](<https://github.com/ghowland/sireus/blob/main/code/webapp/params.go#L139>)

```go
func FormatInteractiveStartTime() string
```

## func [GetRenderMapFromParams](<https://github.com/ghowland/sireus/blob/main/code/webapp/params.go#L18>)

```go
func GetRenderMapFromParams(c *fiber.Ctx, site *data.Site) fiber.Map
```

GetRenderMapFromParams parses GET params passes in all the data for a given Handlebars page render, using Fiber

## func [GetRenderMapFromRPC](<https://github.com/ghowland/sireus/blob/main/code/webapp/params.go#L47>)

```go
func GetRenderMapFromRPC(c *fiber.Ctx, site *data.Site) map[string]interface{}
```

GetRenderMapFromRPC parses RPC params and passes in all the data for a given Handlebars page render, using go map. This uses the Interactive Control data to modify data based on the settings.

## func [RegisterHandlebarsHelpers](<https://github.com/ghowland/sireus/blob/main/code/webapp/register_helpers.go#L17>)

```go
func RegisterHandlebarsHelpers()
```

Main function to register all the different Handlebars helper functions, for text processing

## func [RegisterHandlebarsHelpers\_FormatData](<https://github.com/ghowland/sireus/blob/main/code/webapp/register_helpers.go#L124>)

```go
func RegisterHandlebarsHelpers_FormatData()
```

Format data, for Go and our internal data types

## func [RegisterHandlebarsHelpers\_GetAppData](<https://github.com/ghowland/sireus/blob/main/code/webapp/register_helpers.go#L106>)

```go
func RegisterHandlebarsHelpers_GetAppData()
```

Get AppData values.  Bot, BotGroup, Action, BotActionData, etc

## func [RegisterHandlebarsHelpers\_IfArrayLength](<https://github.com/ghowland/sireus/blob/main/code/webapp/register_helpers.go#L167>)

```go
func RegisterHandlebarsHelpers_IfArrayLength()
```

Testing Length of Arrays for the different structs

## func [RegisterHandlebarsHelpers\_IfTests](<https://github.com/ghowland/sireus/blob/main/code/webapp/register_helpers.go#L54>)

```go
func RegisterHandlebarsHelpers_IfTests()
```

Expanded test logic

## func [RegisterHandlebarsHelpers\_WithData](<https://github.com/ghowland/sireus/blob/main/code/webapp/register_helpers.go#L35>)

```go
func RegisterHandlebarsHelpers_WithData()
```

Sets current data from otherwise inaccessible data structures, because of slicing, map references, looks ups, etc



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
